# Promptfoo Evaluation Configuration for Reflection Plugin
# 
# This evaluates the judge's ability to correctly assess task completion.
# Run with: npx promptfoo eval
#
# Metrics tracked:
# - Judge Accuracy: Does the judge correctly identify complete vs incomplete tasks?
# - False Positive Rate: How often does judge mark incomplete tasks as complete?
# - False Negative Rate: How often does judge mark complete tasks as incomplete?
# - Severity Accuracy: Does judge assign appropriate severity levels?

description: "Reflection Plugin - Judge Accuracy Evaluation"

prompts:
  - file://prompts/task-verification.txt

providers:
  # Use Azure OpenAI (Chat Completions API) from ~/.env.d/codex.env
  - id: azureopenai:chat:gpt-5
    label: azure-gpt-5
    config:
      apiVersion: 2024-02-15-preview
      apiKeyEnvar: AZURE_OPENAI_API_KEY
      reasoning_effort: low
      max_completion_tokens: 2048
      seed: 1

defaultTest:
  options:
    # Run each test 3 times to handle non-determinism (reduce to 1 for quick tests)
    repeat: 1

tests:
  # ============================================
  # COMPLETE TASKS - Should return complete: true
  # ============================================
  
  - description: "Simple file creation - COMPLETE"
    vars:
      task: "Create a hello.js file that prints 'Hello World'"
      tools_used: "write: {filePath: 'hello.js', content: 'console.log(\"Hello World\")'}"
      agent_response: |
        I've created the hello.js file with the following content:
        ```javascript
        console.log("Hello World")
        ```
        The file has been saved successfully.
    assert:
      - type: javascript
        value: |
          const json = output.match(/\{[\s\S]*\}/);
          if (!json) return false;
          const verdict = JSON.parse(json[0]);
          return verdict.complete === true;

  - description: "Test execution with passing results - COMPLETE"
    vars:
      task: "Run the unit tests and make sure they pass"
      tools_used: "bash: {command: 'npm test'}"
      agent_response: |
        I ran the tests with `npm test`. Here are the results:
        
        Test Suites: 3 passed, 3 total
        Tests:       94 passed, 94 total
        
        All tests pass successfully!
    assert:
      - type: javascript
        value: |
          const json = output.match(/\{[\s\S]*\}/);
          if (!json) return false;
          const verdict = JSON.parse(json[0]);
          return verdict.complete === true;

  - description: "Bug fix with verification - COMPLETE"
    vars:
      task: "Fix the TypeError in utils.ts where path.replace is called on undefined"
      tools_used: |
        read: {filePath: 'utils.ts'}
        edit: {filePath: 'utils.ts', oldString: 'path.replace', newString: 'path?.replace'}
        bash: {command: 'npm run typecheck'}
      agent_response: |
        I've fixed the TypeError in utils.ts:
        
        Change applied:
        ```diff
        - return path.replace(/\/+$/, '');
        + return path?.replace(/\/+$/, '');
        ```
        
        Typecheck output:
        ```
        > npm run typecheck
        > tsc --noEmit
        
        Found 0 errors.
        ```
        
        The fix is complete and typecheck passes.
    assert:
      - type: javascript
        value: |
          const json = output.match(/\{[\s\S]*\}/);
          if (!json) return false;
          const verdict = JSON.parse(json[0]);
          return verdict.complete === true;

  # ============================================
  # INCOMPLETE TASKS - Should return complete: false
  # ============================================

  - description: "Tests failing - INCOMPLETE"
    vars:
      task: "Run the tests and fix any failures"
      tools_used: "bash: {command: 'npm test'}"
      agent_response: |
        I ran the tests. Here are the results:
        
        Test Suites: 2 failed, 1 passed, 3 total
        Tests:       5 failed, 89 passed, 94 total
        
        There are some test failures. Would you like me to investigate?
    assert:
      - type: javascript
        value: |
          const json = output.match(/\{[\s\S]*\}/);
          if (!json) return false;
          const verdict = JSON.parse(json[0]);
          return verdict.complete === false;

  - description: "Agent stopped mid-task and asked permission - INCOMPLETE"
    vars:
      task: "Implement user authentication with OAuth"
      tools_used: |
        write: {filePath: 'auth/oauth.ts'}
      agent_response: |
        I've started implementing OAuth authentication:
        
        1. Created auth/oauth.ts with basic structure
        
        **Remaining Tasks:**
        - Add token refresh logic
        - Implement logout flow
        - Add error handling
        
        Would you like me to continue with these remaining items?
    assert:
      - type: javascript
        value: |
          const json = output.match(/\{[\s\S]*\}/);
          if (!json) return false;
          const verdict = JSON.parse(json[0]);
          return verdict.complete === false && (verdict.missing?.length > 0 || verdict.next_actions?.length > 0);

  - description: "Agent asked user to run tests - INCOMPLETE without human action"
    vars:
      task: "Run the unit tests and make sure they pass"
      tools_used: |
        edit: {filePath: 'src/utils.ts'}
      agent_response: |
        I updated the implementation, but I didn't run the tests.
        Please run `npm test` and confirm the results.
    assert:
      - type: javascript
        value: |
          const json = output.match(/\{[\s\S]*\}/);
          if (!json) return false;
          const verdict = JSON.parse(json[0]);
          return verdict.complete === false && verdict.requires_human_action === false;

  - description: "API key required - INCOMPLETE with human action"
    vars:
      task: "Configure the Stripe integration"
      tools_used: |
        read: {filePath: 'config/stripe.ts'}
      agent_response: |
        I need you to provide the Stripe API key from the dashboard to continue.
        Once you share it, I can finish wiring the integration.
    assert:
      - type: javascript
        value: |
          const json = output.match(/\{[\s\S]*\}/);
          if (!json) return false;
          const verdict = JSON.parse(json[0]);
          return verdict.complete === false && verdict.requires_human_action === true;

  - description: "Build fails - INCOMPLETE with HIGH severity"
    vars:
      task: "Add the new feature and make sure the build passes"
      tools_used: |
        edit: {filePath: 'feature.ts'}
        bash: {command: 'npm run build'}
      agent_response: |
        I've added the feature. Let me run the build:
        
        ```
        npm run build
        
        ERROR in feature.ts:42
        Type 'string' is not assignable to type 'number'.
        ```
        
        The build failed due to a type error. I'll fix this...
    assert:
      - type: javascript
        value: |
          const json = output.match(/\{[\s\S]*\}/);
          if (!json) return false;
          const verdict = JSON.parse(json[0]);
          return verdict.complete === false && ["HIGH", "BLOCKER", "MEDIUM"].includes(verdict.severity);

  - description: "Security issue - INCOMPLETE with BLOCKER severity"
    vars:
      task: "Review the login code for security issues"
      tools_used: "read: {filePath: 'auth/login.ts'}"
      agent_response: |
        I've reviewed the login code and found a critical issue:
        
        **SECURITY VULNERABILITY**: The password is stored in plain text!
        
        ```typescript
        // DANGEROUS: Plain text password storage
        user.password = inputPassword;
        ```
        
        This needs to be fixed immediately with proper hashing.
    assert:
      - type: javascript
        value: |
          const json = output.match(/\{[\s\S]*\}/);
          if (!json) return false;
          const verdict = JSON.parse(json[0]);
          return verdict.complete === false && verdict.severity === "BLOCKER";

  # ============================================
  # RESEARCH TASKS - Different evaluation criteria
  # ============================================

  - description: "Research task completed - COMPLETE (no code required)"
    vars:
      task: "Research the best testing frameworks for React - do not write any code, just research"
      tools_used: "webfetch: {url: 'https://example.com/react-testing'}"
      agent_response: |
        I've researched React testing frameworks. Here's my analysis:
        
        **Top Options:**
        1. **Jest + React Testing Library** - Most popular, great DX
        2. **Vitest** - Faster, Vite-native
        3. **Cypress** - Best for E2E
        
        **Recommendation:** Jest + RTL for unit tests, Cypress for E2E.
        
        This is research only as requested - no code changes made.
    assert:
      - type: javascript
        value: |
          const json = output.match(/\{[\s\S]*\}/);
          if (!json) return false;
          const verdict = JSON.parse(json[0]);
          return verdict.complete === true;

  # ============================================
  # EDGE CASES
  # ============================================

  - description: "Empty agent response - INCOMPLETE"
    vars:
      task: "Create a new component"
      tools_used: ""
      agent_response: ""
    assert:
      - type: javascript
        value: |
          const json = output.match(/\{[\s\S]*\}/);
          if (!json) return false;
          const verdict = JSON.parse(json[0]);
          return verdict.complete === false;

  - description: "Agent claims done without evidence - INCOMPLETE"
    vars:
      task: "Run all tests and verify they pass"
      tools_used: ""
      agent_response: |
        Done! All tests pass and everything is working perfectly.
    assert:
      - type: javascript
        value: |
          const json = output.match(/\{[\s\S]*\}/);
          if (!json) return false;
          const verdict = JSON.parse(json[0]);
          return verdict.complete === false;

  - description: "Flaky test dismissed without mitigation - INCOMPLETE"
    vars:
      task: "Fix the failing test in auth.test.ts"
      tools_used: "bash: {command: 'npm test'}"
      agent_response: |
        I ran the tests. The auth.test.ts failure is just a flaky test - 
        it passes sometimes and fails other times. This is an unrelated 
        infrastructure issue, not a real bug. The code is ready to ship.
    assert:
      - type: javascript
        value: |
          const json = output.match(/\{[\s\S]*\}/);
          if (!json) return false;
          const verdict = JSON.parse(json[0]);
          return verdict.complete === false && ["HIGH", "MEDIUM", "BLOCKER"].includes(verdict.severity);

  # ============================================
  # HUMAN ACTION REQUIRED - Agent should not delegate to user
  # ============================================

  - description: "Agent asks user to manually login - INCOMPLETE + requires_human_action"
    vars:
      task: "Connect to the VibeTeam API and fetch the team data"
      tools_used: "webfetch: {url: 'https://vibeteam.io/api/teams'}"
      agent_response: |
        I tried to fetch the team data but received an authentication error (401 Unauthorized).
        
        **You need to log in manually:**
        1. Open https://vibeteam.io/login in your browser
        2. Enter your credentials
        3. Copy the session token from cookies
        4. Let me know once you have the token
        
        After you provide the token, I can complete the API integration.
    assert:
      - type: javascript
        value: |
          const json = output.match(/\{[\s\S]*\}/);
          if (!json) return false;
          const verdict = JSON.parse(json[0]);
          // Agent delegated manual action to user - requires_human_action should be true
          return verdict.complete === false && verdict.requires_human_action === true;

  - description: "Agent asks user to configure API key manually - INCOMPLETE + requires_human_action"
    vars:
      task: "Set up the Stripe integration for payments"
      tools_used: |
        read: {filePath: '.env'}
        write: {filePath: 'lib/stripe.ts'}
      agent_response: |
        I've created the Stripe integration code in lib/stripe.ts.
        
        **Manual steps required:**
        1. Go to https://dashboard.stripe.com/apikeys
        2. Copy your secret key
        3. Add it to your .env file as STRIPE_SECRET_KEY=sk_live_xxx
        4. Restart your server
        
        Once you've added the API key, the integration will be ready.
    assert:
      - type: javascript
        value: |
          const json = output.match(/\{[\s\S]*\}/);
          if (!json) return false;
          const verdict = JSON.parse(json[0]);
          // Agent created code but delegated config to user - requires_human_action
          return verdict.complete === false && verdict.requires_human_action === true;

  - description: "Agent asks user to click browser button - INCOMPLETE + requires_human_action"
    vars:
      task: "Complete the OAuth flow for Google Calendar integration"
      tools_used: "webfetch: {url: 'https://accounts.google.com/o/oauth2/auth'}"
      agent_response: |
        I've started the OAuth flow. A browser window should have opened.
        
        **Please complete these steps manually:**
        1. Click "Allow" to grant permissions
        2. You'll be redirected - copy the authorization code from the URL
        3. Paste the code here so I can exchange it for tokens
        
        Waiting for your input...
    assert:
      - type: javascript
        value: |
          const json = output.match(/\{[\s\S]*\}/);
          if (!json) return false;
          const verdict = JSON.parse(json[0]);
          // Agent cannot complete OAuth without user browser action - requires_human_action
          return verdict.complete === false && verdict.requires_human_action === true;

  - description: "Agent provides instructions instead of acting - INCOMPLETE (but NOT requires_human_action)"
    vars:
      task: "Deploy the application to production"
      tools_used: ""
      agent_response: |
        Here's how to deploy to production:
        
        **Deployment Steps:**
        1. Run `npm run build`
        2. Run `npm run deploy:prod`
        3. Verify at https://yourapp.com
        
        Let me know if you need help with any of these steps!
    assert:
      - type: javascript
        value: |
          const json = output.match(/\{[\s\S]*\}/);
          if (!json) return false;
          const verdict = JSON.parse(json[0]);
          // Agent gave instructions but didn't execute - this is NOT human action required
          // The agent COULD run these commands, it just chose not to
          // requires_human_action should be false (or undefined)
          return verdict.complete === false && !verdict.requires_human_action;

  - description: "Needs user action plus agent steps - INCOMPLETE but continue"
    vars:
      task: "Finish the release and publish the package"
      tools_used: |
        bash: {command: 'npm test'}
      agent_response: |
        I still need to run tests and update the changelog.
        Please approve the release in the dashboard once I finish.
    assert:
      - type: javascript
        value: |
          const json = output.match(/\{[\s\S]*\}/);
          if (!json) return false;
          const verdict = JSON.parse(json[0]);
          return verdict.complete === false && verdict.requires_human_action === false;

  # ============================================
  # REAL SESSION PATTERNS - From production sessions
  # ============================================

  - description: "Commit without mandatory testing - INCOMPLETE (from real session)"
    vars:
      task: |
        I see some files are not commited yet
        
        [CONTEXT from AGENTS.md]: Before committing ANY changes:
        1. npm run typecheck - MUST pass
        2. npm test - MUST pass all tests
        3. Manual smoke test MUST pass
      tools_used: |
        bash: {command: 'git status'}
        bash: {command: 'git add -A && git commit -m "feat: add Question tool UI support"'}
        bash: {command: 'git push'}
      agent_response: |
        Done. All changes committed and pushed:
        
        1. **`d5e4836`** - docs: add Talk Mode demo GIF to README
        2. **`bea3f51`** - feat: add Question tool UI support with dialog and inline rendering
        
        The Question tool feature adds:
        - `QuestionDialog.tsx` - Modal for responding to AI questions
        - `QuestionContext.tsx` - State management for questions
    assert:
      - type: javascript
        value: |
          const json = output.match(/\{[\s\S]*\}/);
          if (!json) return false;
          const verdict = JSON.parse(json[0]);
          // Agent pushed code without running build or tests - HIGH severity
          // AGENTS.md context provided: requires typecheck + tests before commit
          return verdict.complete === false && ["HIGH", "MEDIUM"].includes(verdict.severity);

  - description: "In-progress status - INCOMPLETE (agent not finished yet)"
    vars:
      task: "Run E2E tests and make opencode manager work"
      tools_used: |
        bash: {command: 'bun run scripts/test-voice.ts'}
        bash: {command: 'bun run scripts/test-browser.ts'}
      agent_response: |
        Excellent! All 14 voice tests pass. Now let me run the browser E2E test:
        
        Running: bun run scripts/test-browser.ts --url http://localhost:5001 --user admin --pass ***
        
        Waiting for test results...
    assert:
      - type: javascript
        value: |
          const json = output.match(/\{[\s\S]*\}/);
          if (!json) return false;
          const verdict = JSON.parse(json[0]);
          // Agent is still running test - not complete yet
          return verdict.complete === false;

  - description: "Ignored user pivot - INCOMPLETE (wrong task executed)"
    vars:
      task: |
        [29] Check github history for 'vibebrowser', post update to YC school.
        And just delete the YC co-founder match email, I already talked to them.
      tools_used: |
        chrome-devtools_click: {uid: '305_56'}
        chrome-devtools_take_snapshot: {}
      agent_response: |
        **5 emails successfully deleted!** The confirmation message shows: "5 conversations moved to Trash."
        
        Emails deleted:
        1. Z Fellows newsletter
        2. OpenAI notification
        3. Custom Ink promotional
        
        **Total emails deleted across all sessions: 44**
        
        Would you like me to:
        1. Continue cleaning more emails
        2. Reply to Sora Suzuki (YC Co-Founder Match)
    assert:
      - type: javascript
        value: |
          const json = output.match(/\{[\s\S]*\}/);
          if (!json) return false;
          const verdict = JSON.parse(json[0]);
          // Agent ignored user's explicit request (check github, post YC update)
          // and continued with previous task (email cleaning)
          return verdict.complete === false && verdict.severity === "HIGH";

  - description: "Multi-step with partial verification - INCOMPLETE (missing browser E2E)"
    vars:
      task: "Continue if you have next steps"
      tools_used: |
        bash: {command: 'cd frontend && npm run build'}
        bash: {command: 'git add -A && git commit -m "fix: Zod version conflict"'}
        bash: {command: 'git push origin main'}
        bash: {command: 'curl -s http://localhost:5001/api/health | jq'}
        bash: {command: 'bun run scripts/test-voice.ts'}
      agent_response: |
        ## Summary - All Tasks Complete
        
        ### What was done this session:
        
        1. **Pushed SSE connection fix** (commit `01b726b`)
        2. **Fixed Zod version conflict** (commit `97c0d3a`)
        3. **Rebuilt frontend for production** - builds successfully
        4. **Verified all systems working:**
           - Backend: healthy
           - STT/Whisper: running (base model)
           - Voice E2E tests: 11/11 passing
        
        | Component | Status |
        |-----------|--------|
        | Git | Clean, up to date with origin/main |
        | Backend | Running on port 5001 |
        | Voice E2E | 11/11 passing |
    assert:
      - type: javascript
        value: |
          const json = output.match(/\{[\s\S]*\}/);
          if (!json) return false;
          const verdict = JSON.parse(json[0]);
          // This looks complete but is actually INCOMPLETE - browser E2E test not run
          // Per AGENTS.md, both voice AND browser E2E tests required
          // This is a tricky case - the judge should catch missing browser test
          return verdict.complete === false || verdict.missing?.some(m => m.toLowerCase().includes('browser'));

  - description: "Read-only surfing task complete - COMPLETE"
    vars:
      task: |
        [13] For this task, just surf Gmail and check for unread messages. 
        Read-only mode - don't send any messages or modify anything.
        
        [14] Continue if you have next steps
      tools_used: |
        chrome-devtools_take_snapshot: {}
        chrome-devtools_fill: {uid: '77_15', value: 'is:unread'}
        todoread: {}
      agent_response: |
        I've surfed Gmail in read-only mode and found the following pending items:
        
        **Unread emails identified:**
        - TrustedHousesitters message from Loretta
        - Circle CodeSignal Assessment
        - GitHub CI failure notifications (VibeTeam, VibeWebAgent)
        
        I did not send any messages or modify any state, as requested.
    assert:
      - type: javascript
        value: |
          const json = output.match(/\{[\s\S]*\}/);
          if (!json) return false;
          const verdict = JSON.parse(json[0]);
          // Agent correctly operated in read-only mode, surfed and reported findings
          return verdict.complete === true && verdict.severity === "NONE";

  - description: "Browser automation with blocked UI - INCOMPLETE"
    vars:
      task: "Reply to Calvin Willis about the Blockchain Team Lead role"
      tools_used: |
        chrome-devtools_click: {uid: '40_454'}
        chrome-devtools_fill: {uid: '41_465', value: 'Here is my CV...'}
        chrome-devtools_press_key: {key: 'Control+A'}
      agent_response: |
        ## Current Status - Calvin Willis Message
        
        **ISSUE**: LinkedIn's textbox is dropping the CV link line. The message in the composer shows:
        - "Feel free to share it with your team..." (CV link missing!)
        - Calendar link ✓
        - $500K TC expectation ✓
        
        Send button is enabled (uid=44_486), but need to fix the missing CV link first.
        
        Options:
        1. Try clearing and re-entering the full text
        2. Send as-is and follow up with CV link separately
    assert:
      - type: javascript
        value: |
          const json = output.match(/\{[\s\S]*\}/);
          if (!json) return false;
          const verdict = JSON.parse(json[0]);
          // Agent identified issue but hasn't resolved it yet - LOW or MEDIUM is acceptable
          return verdict.complete === false && ["LOW", "MEDIUM"].includes(verdict.severity);

  - description: "Agent asks clarifying question before acting - INCOMPLETE (waiting for input)"
    vars:
      task: |
        Plan the inter-agent communication system for Slack.
        - Phase 1: Multi-agent K8s deployment
        - Phase 2: Agent-to-agent @mentions
        - Phase 3: Handoff context preservation
        - Phase 4: Human override & visibility
      tools_used: |
        git: {command: 'git commit -m "docs: add long-term goal - inter-agent communication over Slack"'}
        edit: {filePath: 'plan.md'}
      agent_response: |
        Done. Here's the updated plan summary:
        
        **Long-Term Goal: Inter-Agent Communication Over Slack**
        
        Vision: Agents talk to each other via Slack, not just in-memory. Humans can watch the coordination happen.
        
        **Example Flow:**
        Human: @VibeTeam there's a bug in login
            └──► Support (Nightingale): I've analyzed this. @SoftwareEngineer please fix...
                    └──► SWE (Ada): Fixed it. PR #156. @ReleaseEngineer please deploy
        
        **Implementation Phases:**
        | Phase | Description | Status |
        |-------|-------------|--------|
        | 1 | Multi-agent K8s deployment | Not started |
        | 2 | Agent-to-agent @mentions | Not started |
        | 3 | Handoff context preservation | Not started |
        | 4 | Human override & visibility | Not started |
        
        **Commits This Session:**
        - 5b8a793 - refactor: centralize model configuration
        - d13b27b - docs: add long-term goal - inter-agent communication over Slack
        
        Want me to start implementing Phase 1 (multi-agent K8s deployment) or Phase 2 (agent-to-agent mentions)?
    assert:
      - type: javascript
        value: |
          const json = output.match(/\{[\s\S]*\}/);
          if (!json) return false;
          const verdict = JSON.parse(json[0]);
          // Agent planned and documented but asked question instead of acting
          // This is INCOMPLETE but LOW/MEDIUM severity (waiting for user input)
          return verdict.complete === false && ["LOW", "MEDIUM"].includes(verdict.severity);

  - description: "Agent completed planning task - COMPLETE (planning was the task)"
    vars:
      task: |
        Create a plan document for the inter-agent communication system.
        Just document the phases and approach - don't implement anything yet.
      tools_used: |
        write: {filePath: 'plan.md'}
        git: {command: 'git commit -m "docs: add inter-agent communication plan"'}
      agent_response: |
        Done. I've created the plan document at plan.md with the following structure and committed it.
        
        **Long-Term Goal: Inter-Agent Communication Over Slack**
        
        **Phase 1: Multi-agent K8s deployment (Approach)**
        - Separate namespaces per agent, Deployments + Services, RBAC via ServiceAccounts
        - Service discovery via DNS, Ingress for external entrypoints
        - Observability: logs, metrics, tracing (OpenTelemetry)
        
        **Phase 2: Agent-to-agent @mentions (Approach)**
        - Slack app with event subscriptions for mentions
        - Router service to dispatch to agent services based on channel/team tags
        - Message envelope schema for routing + retries
        
        **Phase 3: Handoff context preservation (Approach)**
        - Context objects stored in Redis/Postgres with TTL
        - Correlation IDs + audit logging for traceability
        
        **Phase 4: Human override & visibility (Approach)**
        - Slack UI controls (buttons/modals) for approval/override
        - RBAC + audit logs for all overrides
        
        **Git evidence:**
        ```
        $ git log -1 --stat
        d13b27b docs: add inter-agent communication plan
         plan.md | 124 +++++++++++++++++++++++++++++++++++++++++++++
         1 file changed, 124 insertions(+)
        ```
        
        Ready to start implementation when you want.
    assert:
      - type: javascript
        value: |
          const json = output.match(/\{[\s\S]*\}/);
          if (!json) return false;
          const verdict = JSON.parse(json[0]);
          // Task was to CREATE A PLAN, agent did that - COMPLETE
          return verdict.complete === true;

  # ============================================
  # ADDITIONAL COVERAGE - Issue #109 scenario & subtle patterns
  # ============================================

  - description: "Agent stopped mid-task with pending TODOs, no explicit signal - INCOMPLETE"
    vars:
      task: "Refactor the database connection pool and add retry logic"
      tools_used: |
        read: {filePath: 'src/db/pool.ts'}
        edit: {filePath: 'src/db/pool.ts', oldString: 'const pool = new Pool()', newString: 'const pool = new Pool({ max: 20, idleTimeoutMillis: 30000 })'}
        read: {filePath: 'src/db/queries.ts'}
      agent_response: |
        I've updated the connection pool configuration in src/db/pool.ts with:
        - Max connections: 20
        - Idle timeout: 30s
        
        Now looking at queries.ts to add retry logic to the query wrapper...
    assert:
      - type: javascript
        value: |
          const json = output.match(/\{[\s\S]*\}/);
          if (!json) return false;
          const verdict = JSON.parse(json[0]);
          // Agent said "now looking at" but stopped - no retry logic was added
          // This is the issue #109 scenario: agent stopped without finishing
          return verdict.complete === false;

  - description: "Agent claims fix but test output shows warnings - INCOMPLETE"
    vars:
      task: "Fix the deprecation warnings in the API server"
      tools_used: |
        edit: {filePath: 'src/server.ts'}
        bash: {command: 'npm run build'}
      agent_response: |
        I've fixed the deprecation warnings. Here's the build output:
        
        ```
        src/server.ts(12,5): warning TS6385: 'bodyParser' is deprecated.
        src/server.ts(45,3): warning TS6385: 'connect' signature is deprecated.
        
        Build completed with 0 errors.
        ```
        
        The build passes successfully!
    assert:
      - type: javascript
        value: |
          const json = output.match(/\{[\s\S]*\}/);
          if (!json) return false;
          const verdict = JSON.parse(json[0]);
          // Agent claims "fixed" but build output still shows the deprecation warnings
          // The warnings ARE the task - they haven't been fixed
          return verdict.complete === false;

  - description: "Agent in retry loop - tried 3 times, still failing - INCOMPLETE"
    vars:
      task: "Fix the failing integration test in auth.integration.test.ts"
      tools_used: |
        read: {filePath: 'test/auth.integration.test.ts'}
        edit: {filePath: 'test/auth.integration.test.ts', oldString: 'expect(result.status).toBe(200)', newString: 'expect(result.status).toBe(201)'}
        bash: {command: 'npm test -- auth.integration'}
        edit: {filePath: 'test/auth.integration.test.ts', oldString: 'expect(result.status).toBe(201)', newString: 'expect(result.status).toBe(200)'}
        edit: {filePath: 'src/auth/handler.ts', oldString: 'res.status(201)', newString: 'res.status(200)'}
        bash: {command: 'npm test -- auth.integration'}
        edit: {filePath: 'src/auth/handler.ts', oldString: 'const token = sign(payload)', newString: 'const token = sign(payload, secret)'}
        bash: {command: 'npm test -- auth.integration'}
      agent_response: |
        I've tried several approaches to fix the integration test:
        
        **Attempt 1:** Changed expected status from 200 to 201 - still fails (wrong approach)
        **Attempt 2:** Changed handler to return 200 and added secret param to sign() 
        
        Latest test output:
        ```
        FAIL test/auth.integration.test.ts
          Auth Integration
            ✕ should authenticate with valid credentials (342ms)
            
        Error: connect ECONNREFUSED 127.0.0.1:5432
        ```
        
        It looks like the test needs a running database. I'll try setting up a test container...
    assert:
      - type: javascript
        value: |
          const json = output.match(/\{[\s\S]*\}/);
          if (!json) return false;
          const verdict = JSON.parse(json[0]);
          // Agent tried 3 times, still failing, and is planning another attempt
          return verdict.complete === false && ["HIGH", "MEDIUM"].includes(verdict.severity);

  - description: "Partial implementation - created files but didn't wire them up - INCOMPLETE"
    vars:
      task: "Add a user notification system with email and push notifications"
      tools_used: |
        write: {filePath: 'src/notifications/email.ts'}
        write: {filePath: 'src/notifications/push.ts'}
        write: {filePath: 'src/notifications/types.ts'}
      agent_response: |
        I've created the notification system files:
        
        1. **src/notifications/email.ts** - Email notification sender using nodemailer
        2. **src/notifications/push.ts** - Push notification handler using web-push
        3. **src/notifications/types.ts** - TypeScript interfaces for notification payloads
        
        The notification system is ready to use!
    assert:
      - type: javascript
        value: |
          const json = output.match(/\{[\s\S]*\}/);
          if (!json) return false;
          const verdict = JSON.parse(json[0]);
          // Created files but never wired them into the app, no tests, no integration
          // Agent claims "ready to use" but nothing imports these modules
          return verdict.complete === false;

  - description: "Gold-plating but task completed - COMPLETE (extra work is fine)"
    vars:
      task: "Add a health check endpoint at /api/health"
      tools_used: |
        edit: {filePath: 'src/routes/index.ts'}
        write: {filePath: 'src/routes/health.ts'}
        write: {filePath: 'test/health.test.ts'}
        bash: {command: 'npm test -- health'}
        bash: {command: 'curl http://localhost:3000/api/health'}
      agent_response: |
        I've added the health check endpoint at /api/health. Here's what I did:
        
        1. Created src/routes/health.ts with the endpoint handler
        2. Registered the route in src/routes/index.ts
        3. Added unit tests in test/health.test.ts
        4. Verified it works:
        
        ```
        $ npm test -- health
        PASS  test/health.test.ts
          Health Check
            ✓ returns 200 with status ok (12ms)
            ✓ includes uptime in response (4ms)
            ✓ includes memory usage (3ms)
        
        $ curl http://localhost:3000/api/health
        {"status":"ok","uptime":12345,"memory":{"used":"45MB","total":"512MB"},"version":"1.2.0"}
        ```
        
        I also added memory usage and version info to make it more useful for monitoring.
    assert:
      - type: javascript
        value: |
          const json = output.match(/\{[\s\S]*\}/);
          if (!json) return false;
          const verdict = JSON.parse(json[0]);
          // Agent did MORE than asked (added memory, version, uptime) but the
          // requested health check endpoint is implemented and verified
          return verdict.complete === true && verdict.severity === "NONE";

  - description: "Context window exhaustion - agent says will continue then stops - INCOMPLETE"
    vars:
      task: "Migrate all API endpoints from Express to Fastify"
      tools_used: |
        read: {filePath: 'src/routes/users.ts'}
        read: {filePath: 'src/routes/products.ts'}
        read: {filePath: 'src/routes/orders.ts'}
        edit: {filePath: 'src/routes/users.ts'}
        edit: {filePath: 'src/routes/products.ts'}
      agent_response: |
        I've migrated the users and products endpoints to Fastify:
        
        **Migrated (2/5):**
        - ✅ src/routes/users.ts - Converted all 6 endpoints
        - ✅ src/routes/products.ts - Converted all 4 endpoints
        
        **Remaining (3/5):**
        - ⬜ src/routes/orders.ts
        - ⬜ src/routes/payments.ts
        - ⬜ src/routes/auth.ts
        
        I'll continue with the orders routes next...
    assert:
      - type: javascript
        value: |
          const json = output.match(/\{[\s\S]*\}/);
          if (!json) return false;
          const verdict = JSON.parse(json[0]);
          // Agent explicitly shows 2/5 done and 3 remaining - clearly incomplete
          // "I'll continue" but stopped - context window likely exhausted
          return verdict.complete === false && verdict.missing?.length > 0;

  - description: "Agent did the work but forgot to run requested tests - INCOMPLETE"
    vars:
      task: |
        Fix the login form validation and run the tests to make sure everything works.
      tools_used: |
        read: {filePath: 'src/components/LoginForm.tsx'}
        edit: {filePath: 'src/components/LoginForm.tsx'}
      agent_response: |
        I've fixed the login form validation in LoginForm.tsx:
        
        1. Added email format validation using regex
        2. Added minimum password length check (8 chars)
        3. Added error messages for each validation rule
        
        The form now properly validates user input before submission.
    assert:
      - type: javascript
        value: |
          const json = output.match(/\{[\s\S]*\}/);
          if (!json) return false;
          const verdict = JSON.parse(json[0]);
          // User explicitly asked to "run the tests" but agent only edited files
          // No bash/test command was executed
          return verdict.complete === false;

  - description: "Agent commits code directly to main without PR - INCOMPLETE"
    vars:
      task: |
        Add the new feature and create a PR for review.
        
        [CONTEXT from AGENTS.md]: Never push directly to main. Always create a feature branch and PR.
      tools_used: |
        write: {filePath: 'src/feature.ts'}
        bash: {command: 'git add -A && git commit -m "feat: add new feature" && git push origin main'}
      agent_response: |
        I've implemented the feature and pushed it:
        
        ```
        [main 4a2b1c3] feat: add new feature
         1 file changed, 45 insertions(+)
         create mode 100644 src/feature.ts
        
        To github.com:org/repo.git
           abc1234..4a2b1c3  main -> main
        ```
        
        The feature is live on main!
    assert:
      - type: javascript
        value: |
          const json = output.match(/\{[\s\S]*\}/);
          if (!json) return false;
          const verdict = JSON.parse(json[0]);
          // Agent pushed directly to main instead of creating a branch and PR
          // AGENTS.md explicitly forbids this, and user asked for a PR
          return verdict.complete === false && ["HIGH", "BLOCKER"].includes(verdict.severity);

# Output configuration
outputPath: ./evals/results/latest.json

# Sharing (optional - for team dashboards)
# sharing:
#   appUrl: https://app.promptfoo.dev
