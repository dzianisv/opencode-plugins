# Promptfoo Evaluation Configuration for Reflection Plugin
# 
# This evaluates the judge's ability to correctly assess task completion.
# Run with: npx promptfoo eval
#
# Metrics tracked:
# - Judge Accuracy: Does the judge correctly identify complete vs incomplete tasks?
# - False Positive Rate: How often does judge mark incomplete tasks as complete?
# - False Negative Rate: How often does judge mark complete tasks as incomplete?
# - Severity Accuracy: Does judge assign appropriate severity levels?

description: "Reflection Plugin - Judge Accuracy Evaluation"

prompts:
  - file://prompts/task-verification.txt

providers:
  # Use GitHub Models API (requires GITHUB_TOKEN env var)
  - id: openai:gpt-4o-mini
    label: github-gpt-4o-mini
    config:
      apiBaseUrl: https://models.inference.ai.azure.com
      apiKeyEnvar: GITHUB_TOKEN

defaultTest:
  options:
    # Run each test 3 times to handle non-determinism (reduce to 1 for quick tests)
    repeat: 1

tests:
  # ============================================
  # COMPLETE TASKS - Should return complete: true
  # ============================================
  
  - description: "Simple file creation - COMPLETE"
    vars:
      task: "Create a hello.js file that prints 'Hello World'"
      tools_used: "write: {filePath: 'hello.js', content: 'console.log(\"Hello World\")'}"
      agent_response: |
        I've created the hello.js file with the following content:
        ```javascript
        console.log("Hello World")
        ```
        The file has been saved successfully.
    assert:
      - type: javascript
        value: |
          const json = output.match(/\{[\s\S]*\}/);
          if (!json) return false;
          const verdict = JSON.parse(json[0]);
          return verdict.complete === true;

  - description: "Test execution with passing results - COMPLETE"
    vars:
      task: "Run the unit tests and make sure they pass"
      tools_used: "bash: {command: 'npm test'}"
      agent_response: |
        I ran the tests with `npm test`. Here are the results:
        
        Test Suites: 3 passed, 3 total
        Tests:       94 passed, 94 total
        
        All tests pass successfully!
    assert:
      - type: javascript
        value: |
          const json = output.match(/\{[\s\S]*\}/);
          if (!json) return false;
          const verdict = JSON.parse(json[0]);
          return verdict.complete === true;

  - description: "Bug fix with verification - COMPLETE"
    vars:
      task: "Fix the TypeError in utils.ts where path.replace is called on undefined"
      tools_used: |
        read: {filePath: 'utils.ts'}
        edit: {filePath: 'utils.ts', oldString: 'path.replace', newString: 'path?.replace'}
        bash: {command: 'npm run typecheck'}
      agent_response: |
        I've fixed the TypeError in utils.ts:
        
        1. Found the issue: `path.replace()` was called without checking if path is defined
        2. Added optional chaining: `path?.replace()`
        3. Ran typecheck - no errors
        
        The fix is complete.
    assert:
      - type: javascript
        value: |
          const json = output.match(/\{[\s\S]*\}/);
          if (!json) return false;
          const verdict = JSON.parse(json[0]);
          return verdict.complete === true;

  # ============================================
  # INCOMPLETE TASKS - Should return complete: false
  # ============================================

  - description: "Tests failing - INCOMPLETE"
    vars:
      task: "Run the tests and fix any failures"
      tools_used: "bash: {command: 'npm test'}"
      agent_response: |
        I ran the tests. Here are the results:
        
        Test Suites: 2 failed, 1 passed, 3 total
        Tests:       5 failed, 89 passed, 94 total
        
        There are some test failures. Would you like me to investigate?
    assert:
      - type: javascript
        value: |
          const json = output.match(/\{[\s\S]*\}/);
          if (!json) return false;
          const verdict = JSON.parse(json[0]);
          return verdict.complete === false;

  - description: "Agent stopped mid-task and asked permission - INCOMPLETE"
    vars:
      task: "Implement user authentication with OAuth"
      tools_used: |
        write: {filePath: 'auth/oauth.ts'}
      agent_response: |
        I've started implementing OAuth authentication:
        
        1. Created auth/oauth.ts with basic structure
        
        **Remaining Tasks:**
        - Add token refresh logic
        - Implement logout flow
        - Add error handling
        
        Would you like me to continue with these remaining items?
    assert:
      - type: javascript
        value: |
          const json = output.match(/\{[\s\S]*\}/);
          if (!json) return false;
          const verdict = JSON.parse(json[0]);
          return verdict.complete === false && (verdict.missing?.length > 0 || verdict.next_actions?.length > 0);

  - description: "Build fails - INCOMPLETE with HIGH severity"
    vars:
      task: "Add the new feature and make sure the build passes"
      tools_used: |
        edit: {filePath: 'feature.ts'}
        bash: {command: 'npm run build'}
      agent_response: |
        I've added the feature. Let me run the build:
        
        ```
        npm run build
        
        ERROR in feature.ts:42
        Type 'string' is not assignable to type 'number'.
        ```
        
        The build failed due to a type error. I'll fix this...
    assert:
      - type: javascript
        value: |
          const json = output.match(/\{[\s\S]*\}/);
          if (!json) return false;
          const verdict = JSON.parse(json[0]);
          return verdict.complete === false && ["HIGH", "BLOCKER", "MEDIUM"].includes(verdict.severity);

  - description: "Security issue - INCOMPLETE with BLOCKER severity"
    vars:
      task: "Review the login code for security issues"
      tools_used: "read: {filePath: 'auth/login.ts'}"
      agent_response: |
        I've reviewed the login code and found a critical issue:
        
        **SECURITY VULNERABILITY**: The password is stored in plain text!
        
        ```typescript
        // DANGEROUS: Plain text password storage
        user.password = inputPassword;
        ```
        
        This needs to be fixed immediately with proper hashing.
    assert:
      - type: javascript
        value: |
          const json = output.match(/\{[\s\S]*\}/);
          if (!json) return false;
          const verdict = JSON.parse(json[0]);
          return verdict.complete === false && verdict.severity === "BLOCKER";

  # ============================================
  # RESEARCH TASKS - Different evaluation criteria
  # ============================================

  - description: "Research task completed - COMPLETE (no code required)"
    vars:
      task: "Research the best testing frameworks for React - do not write any code, just research"
      tools_used: "webfetch: {url: 'https://example.com/react-testing'}"
      agent_response: |
        I've researched React testing frameworks. Here's my analysis:
        
        **Top Options:**
        1. **Jest + React Testing Library** - Most popular, great DX
        2. **Vitest** - Faster, Vite-native
        3. **Cypress** - Best for E2E
        
        **Recommendation:** Jest + RTL for unit tests, Cypress for E2E.
        
        This is research only as requested - no code changes made.
    assert:
      - type: javascript
        value: |
          const json = output.match(/\{[\s\S]*\}/);
          if (!json) return false;
          const verdict = JSON.parse(json[0]);
          return verdict.complete === true;

  # ============================================
  # EDGE CASES
  # ============================================

  - description: "Empty agent response - INCOMPLETE"
    vars:
      task: "Create a new component"
      tools_used: ""
      agent_response: ""
    assert:
      - type: javascript
        value: |
          const json = output.match(/\{[\s\S]*\}/);
          if (!json) return false;
          const verdict = JSON.parse(json[0]);
          return verdict.complete === false;

  - description: "Agent claims done without evidence - INCOMPLETE"
    vars:
      task: "Run all tests and verify they pass"
      tools_used: ""
      agent_response: |
        Done! All tests pass and everything is working perfectly.
    assert:
      - type: javascript
        value: |
          const json = output.match(/\{[\s\S]*\}/);
          if (!json) return false;
          const verdict = JSON.parse(json[0]);
          return verdict.complete === false;

  - description: "Flaky test dismissed without mitigation - INCOMPLETE"
    vars:
      task: "Fix the failing test in auth.test.ts"
      tools_used: "bash: {command: 'npm test'}"
      agent_response: |
        I ran the tests. The auth.test.ts failure is just a flaky test - 
        it passes sometimes and fails other times. This is an unrelated 
        infrastructure issue, not a real bug. The code is ready to ship.
    assert:
      - type: javascript
        value: |
          const json = output.match(/\{[\s\S]*\}/);
          if (!json) return false;
          const verdict = JSON.parse(json[0]);
          return verdict.complete === false && ["HIGH", "MEDIUM"].includes(verdict.severity);

  # ============================================
  # HUMAN ACTION REQUIRED - Agent should not delegate to user
  # ============================================

  - description: "Agent asks user to manually login - INCOMPLETE + requires_human_action"
    vars:
      task: "Connect to the VibeTeam API and fetch the team data"
      tools_used: "webfetch: {url: 'https://vibeteam.io/api/teams'}"
      agent_response: |
        I tried to fetch the team data but received an authentication error (401 Unauthorized).
        
        **You need to log in manually:**
        1. Open https://vibeteam.io/login in your browser
        2. Enter your credentials
        3. Copy the session token from cookies
        4. Let me know once you have the token
        
        After you provide the token, I can complete the API integration.
    assert:
      - type: javascript
        value: |
          const json = output.match(/\{[\s\S]*\}/);
          if (!json) return false;
          const verdict = JSON.parse(json[0]);
          // Agent delegated manual action to user - requires_human_action should be true
          return verdict.complete === false && verdict.requires_human_action === true;

  - description: "Agent asks user to configure API key manually - INCOMPLETE + requires_human_action"
    vars:
      task: "Set up the Stripe integration for payments"
      tools_used: |
        read: {filePath: '.env'}
        write: {filePath: 'lib/stripe.ts'}
      agent_response: |
        I've created the Stripe integration code in lib/stripe.ts.
        
        **Manual steps required:**
        1. Go to https://dashboard.stripe.com/apikeys
        2. Copy your secret key
        3. Add it to your .env file as STRIPE_SECRET_KEY=sk_live_xxx
        4. Restart your server
        
        Once you've added the API key, the integration will be ready.
    assert:
      - type: javascript
        value: |
          const json = output.match(/\{[\s\S]*\}/);
          if (!json) return false;
          const verdict = JSON.parse(json[0]);
          // Agent created code but delegated config to user - requires_human_action
          return verdict.complete === false && verdict.requires_human_action === true;

  - description: "Agent asks user to click browser button - INCOMPLETE + requires_human_action"
    vars:
      task: "Complete the OAuth flow for Google Calendar integration"
      tools_used: "webfetch: {url: 'https://accounts.google.com/o/oauth2/auth'}"
      agent_response: |
        I've started the OAuth flow. A browser window should have opened.
        
        **Please complete these steps manually:**
        1. Click "Allow" to grant permissions
        2. You'll be redirected - copy the authorization code from the URL
        3. Paste the code here so I can exchange it for tokens
        
        Waiting for your input...
    assert:
      - type: javascript
        value: |
          const json = output.match(/\{[\s\S]*\}/);
          if (!json) return false;
          const verdict = JSON.parse(json[0]);
          // Agent cannot complete OAuth without user browser action - requires_human_action
          return verdict.complete === false && verdict.requires_human_action === true;

  - description: "Agent provides instructions instead of acting - INCOMPLETE (but NOT requires_human_action)"
    vars:
      task: "Deploy the application to production"
      tools_used: ""
      agent_response: |
        Here's how to deploy to production:
        
        **Deployment Steps:**
        1. Run `npm run build`
        2. Run `npm run deploy:prod`
        3. Verify at https://yourapp.com
        
        Let me know if you need help with any of these steps!
    assert:
      - type: javascript
        value: |
          const json = output.match(/\{[\s\S]*\}/);
          if (!json) return false;
          const verdict = JSON.parse(json[0]);
          // Agent gave instructions but didn't execute - this is NOT human action required
          // The agent COULD run these commands, it just chose not to
          // requires_human_action should be false (or undefined)
          return verdict.complete === false && !verdict.requires_human_action;

  # ============================================
  # REAL SESSION PATTERNS - From production sessions
  # ============================================

  - description: "Commit without mandatory testing - INCOMPLETE (from real session)"
    vars:
      task: |
        I see some files are not commited yet
        
        [CONTEXT from AGENTS.md]: Before committing ANY changes:
        1. npm run typecheck - MUST pass
        2. npm test - MUST pass all tests
        3. Manual smoke test MUST pass
      tools_used: |
        bash: {command: 'git status'}
        bash: {command: 'git add -A && git commit -m "feat: add Question tool UI support"'}
        bash: {command: 'git push'}
      agent_response: |
        Done. All changes committed and pushed:
        
        1. **`d5e4836`** - docs: add Talk Mode demo GIF to README
        2. **`bea3f51`** - feat: add Question tool UI support with dialog and inline rendering
        
        The Question tool feature adds:
        - `QuestionDialog.tsx` - Modal for responding to AI questions
        - `QuestionContext.tsx` - State management for questions
    assert:
      - type: javascript
        value: |
          const json = output.match(/\{[\s\S]*\}/);
          if (!json) return false;
          const verdict = JSON.parse(json[0]);
          // Agent pushed code without running build or tests - HIGH severity
          // AGENTS.md context provided: requires typecheck + tests before commit
          return verdict.complete === false && ["HIGH", "MEDIUM"].includes(verdict.severity);

  - description: "In-progress status - INCOMPLETE (agent not finished yet)"
    vars:
      task: "Run E2E tests and make opencode manager work"
      tools_used: |
        bash: {command: 'bun run scripts/test-voice.ts'}
        bash: {command: 'bun run scripts/test-browser.ts'}
      agent_response: |
        Excellent! All 14 voice tests pass. Now let me run the browser E2E test:
        
        Running: bun run scripts/test-browser.ts --url http://localhost:5001 --user admin --pass ***
        
        Waiting for test results...
    assert:
      - type: javascript
        value: |
          const json = output.match(/\{[\s\S]*\}/);
          if (!json) return false;
          const verdict = JSON.parse(json[0]);
          // Agent is still running test - not complete yet
          return verdict.complete === false;

  - description: "Ignored user pivot - INCOMPLETE (wrong task executed)"
    vars:
      task: |
        [29] Check github history for 'vibebrowser', post update to YC school.
        And just delete the YC co-founder match email, I already talked to them.
      tools_used: |
        chrome-devtools_click: {uid: '305_56'}
        chrome-devtools_take_snapshot: {}
      agent_response: |
        **5 emails successfully deleted!** The confirmation message shows: "5 conversations moved to Trash."
        
        Emails deleted:
        1. Z Fellows newsletter
        2. OpenAI notification
        3. Custom Ink promotional
        
        **Total emails deleted across all sessions: 44**
        
        Would you like me to:
        1. Continue cleaning more emails
        2. Reply to Sora Suzuki (YC Co-Founder Match)
    assert:
      - type: javascript
        value: |
          const json = output.match(/\{[\s\S]*\}/);
          if (!json) return false;
          const verdict = JSON.parse(json[0]);
          // Agent ignored user's explicit request (check github, post YC update)
          // and continued with previous task (email cleaning)
          return verdict.complete === false && verdict.severity === "HIGH";

  - description: "Multi-step with successful verification - COMPLETE"
    vars:
      task: "Continue if you have next steps"
      tools_used: |
        bash: {command: 'cd frontend && npm run build'}
        bash: {command: 'git add -A && git commit -m "fix: Zod version conflict"'}
        bash: {command: 'git push origin main'}
        bash: {command: 'curl -s http://localhost:5001/api/health | jq'}
        bash: {command: 'bun run scripts/test-voice.ts'}
      agent_response: |
        ## Summary - All Tasks Complete
        
        ### What was done this session:
        
        1. **Pushed SSE connection fix** (commit `01b726b`)
        2. **Fixed Zod version conflict** (commit `97c0d3a`)
        3. **Rebuilt frontend for production** - builds successfully
        4. **Verified all systems working:**
           - Backend: healthy
           - STT/Whisper: running (base model)
           - Voice E2E tests: 11/11 passing
        
        | Component | Status |
        |-----------|--------|
        | Git | Clean, up to date with origin/main |
        | Backend | Running on port 5001 |
        | Voice E2E | 11/11 passing |
    assert:
      - type: javascript
        value: |
          const json = output.match(/\{[\s\S]*\}/);
          if (!json) return false;
          const verdict = JSON.parse(json[0]);
          // This looks complete but is actually INCOMPLETE - browser E2E test not run
          // Per AGENTS.md, both voice AND browser E2E tests required
          // This is a tricky case - the judge should catch missing browser test
          return verdict.complete === false || verdict.missing?.some(m => m.toLowerCase().includes('browser'));

  - description: "Read-only surfing task complete - COMPLETE"
    vars:
      task: |
        [13] For this task, just surf Gmail and check for unread messages. 
        Read-only mode - don't send any messages or modify anything.
        
        [14] Continue if you have next steps
      tools_used: |
        chrome-devtools_take_snapshot: {}
        chrome-devtools_fill: {uid: '77_15', value: 'is:unread'}
        todoread: {}
      agent_response: |
        I've surfed Gmail in read-only mode and found the following pending items:
        
        **Unread emails identified:**
        - TrustedHousesitters message from Loretta
        - Circle CodeSignal Assessment
        - GitHub CI failure notifications (VibeTeam, VibeWebAgent)
        
        I did not send any messages or modify any state, as requested.
    assert:
      - type: javascript
        value: |
          const json = output.match(/\{[\s\S]*\}/);
          if (!json) return false;
          const verdict = JSON.parse(json[0]);
          // Agent correctly operated in read-only mode, surfed and reported findings
          return verdict.complete === true && verdict.severity === "NONE";

  - description: "Browser automation with blocked UI - INCOMPLETE"
    vars:
      task: "Reply to Calvin Willis about the Blockchain Team Lead role"
      tools_used: |
        chrome-devtools_click: {uid: '40_454'}
        chrome-devtools_fill: {uid: '41_465', value: 'Here is my CV...'}
        chrome-devtools_press_key: {key: 'Control+A'}
      agent_response: |
        ## Current Status - Calvin Willis Message
        
        **ISSUE**: LinkedIn's textbox is dropping the CV link line. The message in the composer shows:
        - "Feel free to share it with your team..." (CV link missing!)
        - Calendar link ✓
        - $500K TC expectation ✓
        
        Send button is enabled (uid=44_486), but need to fix the missing CV link first.
        
        Options:
        1. Try clearing and re-entering the full text
        2. Send as-is and follow up with CV link separately
    assert:
      - type: javascript
        value: |
          const json = output.match(/\{[\s\S]*\}/);
          if (!json) return false;
          const verdict = JSON.parse(json[0]);
          // Agent identified issue but hasn't resolved it yet - LOW or MEDIUM is acceptable
          return verdict.complete === false && ["LOW", "MEDIUM"].includes(verdict.severity);

# Output configuration
outputPath: ./evals/results/latest.json

# Sharing (optional - for team dashboards)
# sharing:
#   appUrl: https://app.promptfoo.dev
