TASK VERIFICATION

Evaluate whether the agent completed what the user asked for.

## User's Request
{{task}}

## Tools Used
{{tools_used}}

## Agent's Response
{{agent_response}}

════════════════════════════════════════

## Evaluation Rules

### Task Type
This is a CODING/ACTION task (unless the task explicitly mentions "research only" or "do not write code")

### Severity Levels
- BLOCKER: security, auth, billing/subscription, data loss, E2E broken, prod health broken → complete MUST be false
- HIGH: major functionality degraded, CI red without approved waiver
- MEDIUM: partial degradation or uncertain coverage
- LOW: cosmetic / non-impacting
- NONE: no issues

### Coding Task Rules
1. All explicitly requested functionality implemented
2. Tests run and pass (if tests were requested or exist)
3. Build/compile succeeds (if applicable)
4. No unhandled errors in output

### Evidence Requirements
Every claim needs evidence. Reject claims like "ready", "verified", "working", "fixed" without:
- Actual command output showing success
- Test name + result
- File changes made

### Flaky Test Protocol
If a test is called "flaky" or "unrelated", require at least ONE of:
- Rerun with pass (show output)
- Quarantine/skip with tracking ticket
- Replacement test validating same requirement
- Stabilization fix applied
Without mitigation → severity >= HIGH, complete: false

### Progress Status Detection
If the agent's response contains explicit progress indicators like:
- "IN PROGRESS", "in progress", "not yet committed"
- "Next steps:", "Remaining tasks:", "TODO:"
- "Phase X of Y complete" (where X < Y)
- "Continue to Phase N", "Proceed to step N"
Then the task is INCOMPLETE (complete: false) regardless of other indicators.
The agent must finish all stated work, not just report status.

### Delegation/Deferral Detection
If the agent's response asks the user to choose or act instead of completing the task:
- "What would you like me to do?"
- "Which option would you prefer?"
- "Let me know if you want me to..."
- "Would you like me to continue?"
- "I can help you with..." followed by numbered options
- Presenting options (1. 2. 3.) without taking action

IMPORTANT: If the agent lists "Remaining Tasks" or "Next Steps" and then asks for permission to continue,
this is PREMATURE STOPPING, not waiting for user input. The agent should complete the stated work.
- Set complete: false
- Set severity: LOW or MEDIUM (not NONE)
- Include the remaining items in "missing" array
- Include concrete next steps in "next_actions" array

### Human Action Required Detection

**CRITICAL DISTINCTION:**
- `requires_human_action: true` = Agent is PHYSICALLY INCAPABLE of completing (needs human browser/credentials/hardware)
- `requires_human_action: false` = Agent CAN do it but chose to give instructions instead (lazy agent)

**Examples of TRUE human action required (requires_human_action: true):**
- OAuth consent: clicking "Allow" in browser popup
- 2FA/MFA: entering codes from authenticator app
- CAPTCHA: solving visual challenges
- API key retrieval: copying secret keys from web dashboards (Stripe, AWS, etc.)
- Manual login: entering username/password in browser
- Physical actions: plugging in devices, clicking hardware buttons

**Examples of agent CAN do but didn't (requires_human_action: false):**
- Running shell commands: `npm run build`, `npm test`, `docker-compose up`
- Executing deployment scripts: the agent has bash/terminal access
- Creating/editing files: the agent has write access
- Making API calls: the agent can use curl/fetch
- Installing dependencies: `npm install`, `pip install`

**Key test:** Ask "Could the agent run this command or action using its available tools (bash, edit, write, webfetch)?" 
- YES → requires_human_action: false
- NO (needs browser UI, credentials, physical access) → requires_human_action: true

When human action is truly required (OAuth consent, 2FA, API key retrieval, manual login):
- Set complete: false
- Set requires_human_action: true
- Set severity: MEDIUM (blocked but not the agent's fault)
- Add specific description of what user needs to do in feedback
- Add "User must provide [token/key/code]" to missing array

When agent CAN do the work but chose to give instructions instead:
- Set complete: false
- Set requires_human_action: false (agent should do it, not user)
- Set severity: LOW or MEDIUM
- Add the commands agent should run to next_actions array

### Temporal Consistency
Reject if:
- Readiness claimed before verification ran
- Later output contradicts earlier "done" claim
- Failures downgraded after-the-fact without new evidence

### Task Deviation Detection (CRITICAL)
If the agent performs a DIFFERENT task than what the user explicitly requested:
- This is a CRITICAL failure - the agent ignored instructions
- Set complete: false
- Set severity: HIGH or BLOCKER
- Example: User asks "check github history and post YC update", agent deletes emails instead
- This is NOT a pivot by the user - the agent unilaterally decided to do something else
- Even if the agent's chosen action succeeded, the REQUESTED task was ignored

### Multi-Verification Tasks
If the user requests multiple types of verification or tests:
- ALL verifications must be completed, not just some
- Partial verification = incomplete task
- Example: "Run voice AND browser E2E tests" → both must run and pass
- Example: "Run tests AND build" → both must succeed
- If agent says "voice tests pass, now running browser..." but doesn't show browser results → incomplete

### Read-Only / Research-Only Tasks
If user explicitly requests read-only operation:
- Key phrases: "just surf", "don't send messages", "research only", "RO permission", "read-only"
- No code/file changes or external actions (emails, messages) required for completion
- Reporting findings IS the deliverable
- Set complete: true if agent gathered and reported information without modifying state
- This is an EXCEPTION to the normal "must produce code" rule

### Mandatory Verification Steps
If the project has documented testing requirements (in AGENTS.md or similar):
- Agent MUST run those tests before claiming completion
- Committing code without running required tests = incomplete
- Common mandatory steps: `npm test`, `npm run build`, E2E tests
- If build/test scripts don't exist, agent should report that, not skip verification

════════════════════════════════════════

Reply with JSON only (no other text):
{
  "complete": true/false,
  "severity": "NONE|LOW|MEDIUM|HIGH|BLOCKER",
  "requires_human_action": true/false,
  "feedback": "brief explanation of verdict",
  "missing": ["list of missing required steps or evidence"],
  "next_actions": ["concrete commands or checks to run"]
}
